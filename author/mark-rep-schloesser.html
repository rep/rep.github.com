<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>rep.github.com - Mark "rep" Schloesser</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="rep.github.com Atom Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">rep.github.com </a></h1>
                <nav><ul>
                    <li><a href="/category/about.html">About</a></li>
                    <li><a href="/category/blog.html">Blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/codegate-2014-automata-re400.html">Codegate CTF 2014 Automata - RE 400</a></h1>
<footer class="post-info">
        <abbr class="published" title="2014-02-26T20:00:00">
                Published: Wed 26 February 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/mark-rep-schloesser.html">Mark "rep" Schloesser</a>
        </address>
<p>In <a href="/category/blog.html">Blog</a>. </p>
<p>tags: <a href="/tag/ctf.html">ctf</a> <a href="/tag/reversing.html">reversing</a> <a href="/tag/codegate.html">codegate</a> </p>
</footer><!-- /.post-info --><p>Automata is a 32 bit Linux ELF binary and listens on a TCP port on the organizer network - one basically has to exploit it. However the binary just wants a command and a verification code as input - and if the code is correct for the given command, it will execute the command.</p>
<div class="highlight"><pre>58.229.183.18 8181 (intermapper) open
[=] Welcome to Automata System [=]

[*] Enter your command: ls
[*] Enter your code: code
[!] Wrong code
</pre></div>
<div class="section" id="reversing-automata">
<h2>Reversing Automata</h2>
<p>The binary is relatively simple, it uses the standard forking socket server template common in many CTF services. In the actual service logic, it sends the instructions to the client and receives the command and code. For both it uses one <tt class="docutils literal">recv(51)</tt> call and ends the buffer with a null-byte. Afterwards it calls <tt class="docutils literal">strtok(buf, &quot; <span class="pre">\t\r\n\&quot;'&quot;)</span></tt> on the resulting buffer, which overwrites the first delimiter with a null-byte, so that basically neither command nor code can have any whitespace in them.</p>
<p>After receiving the inputs, a first verification stage occurs. For this, the command is checked with the following function.</p>
<div class="highlight"><pre><span class="n">check_command</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span> <span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="mi">37</span> <span class="o">*</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="n">cmd</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
  <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">%</span> <span class="mh">0x11</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">output</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">43</span> <span class="o">-</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">output</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
<p>It basically calculates 3 numbers, which are important for the next part - the verification code needs to have an appropriate number of characters in it:</p>
<div class="highlight"><pre><span class="n">count_3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count_2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">code</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span> <span class="p">{</span>
  <span class="n">m</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="mi">16</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span>
    <span class="o">++</span><span class="n">count_2</span><span class="p">;</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span>
      <span class="o">++</span><span class="n">count_3</span><span class="p">;</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">m</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="n">wrong_code_do_exit</span><span class="p">(</span><span class="n">socketfd</span><span class="p">);</span>
      <span class="o">++</span><span class="n">count_1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span> <span class="n">command_check</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">count_1</span> <span class="o">||</span> <span class="n">command_check</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">count_2</span> <span class="o">||</span> <span class="n">command_check</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">count_3</span> <span class="p">)</span>
  <span class="n">wrong_code_do_exit</span><span class="p">(</span><span class="n">socketfd</span><span class="p">);</span>
</pre></div>
<p>What this means is that the verification code needs to have an appropriate amount of <tt class="docutils literal">a, b, c</tt> characters in it for the previously computed numbers on the command.</p>
</div>
<div class="section" id="the-automaton">
<h2>The Automaton</h2>
<p>After the initial verification stage, the more complicated part is reached. The binary creates subprocesses and pipes, sets up signal handling for signals 10 and 12 and then sits in a tight loop. The subprocesses and pipes represent the automaton - basically the processes are states and transitions occur by writing a number through the pipes.</p>
<p>Automaton creates 8 subprocesses and 20 pipes.</p>
<p>Each process reads from a few pipes (1-5) and writes to one of three output pipes. The automaton basically takes the code received earlier as input. The characters <tt class="docutils literal">a,b,c</tt> in the code make the automaton transition from state to state.</p>
<p>It turns out that the parent will execute the command if it receives signal 10 and just says <tt class="docutils literal">Wrong code</tt> and exits on signal 12. The signal is sent by either of the child processes when the character at position 43 in the code is processed. All subprocesses use signal 10, except for the last process (number 8). So that last process #8 represents the end-state and we need to make sure that we do not enter that state with our input because it turns out that state 8 will only transition to itself.</p>
<a class="reference external image-reference" href="pictures/automaton_drawing.jpg"><img alt="automaton drawing" class="align-center" src="pictures/automaton_drawing.jpg" style="width: 400px; height: 300px;" /></a>
</div>
<div class="section" id="command-and-code">
<h2>Command and Code</h2>
<p>Alright so we need to figure out a command that will get us the key and we can't have any whitespace in there. However as it is a forking socket-server, the socket fd will be the same number in every child - it is fd <tt class="docutils literal">4</tt>. So how about <tt class="docutils literal"><span class="pre">cat&lt;key&gt;&amp;4</span></tt> - this will be executed by automata through the <tt class="docutils literal">system()</tt> library function - inherits the parent descriptors and thus gives us the key.</p>
<p>We determine the amount of <tt class="docutils literal">a,b,c</tt> characters needed for the first verification step: 39 As, 2 Bs and 2 Cs</p>
<p>Then we look at our drawing and figure out an order that stays away from state 8: <tt class="docutils literal">cabcaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaab</tt></p>
<p>Fingers crossed and fire:</p>
<div class="highlight"><pre>58.229.183.18 8181 (intermapper) open
[=] Welcome to Automata System [=]

[*] Enter your command: cat&lt;key&gt;&amp;4
[*] Enter your code: cabcaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaab
[*] Verifying your code
[!] Registered
F4ILUrE_Is_N0T_an_O0PtI1On
</pre></div>
<p>This challenge was pretty cool - the reversing was relatively simple, but the states and pipe numbers had to be kept track off in a very exact way. I swapped around two transitions on my sheet of paper and it took me an hour to figure that out :)</p>
<p>Anyway, good fun!</p>
<blockquote>
-- mark</blockquote>
</div>
                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="/defcon-ctf-quals-2013-sc1.html" rel="bookmark"
                           title="Permalink to DEFCON CTF Quals 2013 - shellcode 1">DEFCON CTF Quals 2013 - shellcode 1</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-06-17T08:00:00">
                Published: Mon 17 June 2013
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/mark-rep-schloesser.html">Mark "rep" Schloesser</a>
        </address>
<p>In <a href="/category/blog.html">Blog</a>. </p>
<p>tags: <a href="/tag/ctf.html">ctf</a> <a href="/tag/exploit.html">exploit</a> <a href="/tag/defcon.html">defcon</a> <a href="/tag/quals.html">quals</a> </p>
</footer><!-- /.post-info -->                <p class="first last">Write-up of solving shellcode 1 aka <tt class="docutils literal">incest</tt> in DEFCON CTF Quals 2013</p>

                <a class="readmore" href="/defcon-ctf-quals-2013-sc1.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/ictf-2012-airplane-exploit.html" rel="bookmark"
                           title="Permalink to UCSB iCTF 2012/2013 - Airplane">UCSB iCTF 2012/2013 - Airplane</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-03-23T20:00:00">
                Published: Sat 23 March 2013
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/mark-rep-schloesser.html">Mark "rep" Schloesser</a>
        </address>
<p>In <a href="/category/blog.html">Blog</a>. </p>
<p>tags: <a href="/tag/ctf.html">ctf</a> <a href="/tag/exploit.html">exploit</a> <a href="/tag/ictf.html">ictf</a> <a href="/tag/ucsb.html">ucsb</a> </p>
</footer><!-- /.post-info -->                <p class="first last">Write-up of exploit development for airplane service in the UCSB iCTF 2012/13</p>

                <a class="readmore" href="/ictf-2012-airplane-exploit.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/about.html" rel="bookmark"
                           title="Permalink to About this site">About this site</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-03-23T00:00:00">
                Published: Sat 23 March 2013
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/mark-rep-schloesser.html">Mark "rep" Schloesser</a>
        </address>
<p>In <a href="/category/about.html">About</a>. </p>

</footer><!-- /.post-info -->                <p>This site is maintainted by Mark &quot;rep&quot; Schloesser. You can find links to my Github / Twitter in the bottom.</p>
<p>You can also drop me an E-Mail according to the following information.</p>
<div class="section" id="key-id-0x0930f6a9">
<h2>Key ID 0x0930F6A9</h2>
<p>Key fingerprint:</p>
<pre class="literal-block">
pub   1024D/0930F6A9 2008-12-01 [expires: 2013-11-30]
  Key fingerprint = 93CE 27F9 3A12 57E5 923B  C10D ...</pre></div>
                <a class="readmore" href="/about.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://honeynet.org">The Honeynet Project</a></li>
                            <li><a href="http://cuckoosandbox.org">Cuckoo Sandbox</a></li>
                            <li><a href="http://map.honeynet.org">HoneyMap</a></li>
                            <li><a href="http://hpfeeds.honeycloud.net">hpfeeds</a></li>
                            <li><a href="http://dexlabs.org">Dexlabs</a></li>
                            <li><a href="http://rapid7.com">Rapid7</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://github.com/rep">Github</a></li>
                            <li><a href="http://twitter.com/repmovsb">Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>